<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>COMERCIAL G.A.</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:'Poppins';
  min-height:100vh;
  display:flex;
  background:linear-gradient(135deg,#0d1b2a,#1b263b,#415a77);
  color:#fff;
}
.sidebar{
  width:250px;
  background:#0d1b2a;
  padding-top:25px;
  border-right:2px solid #f1c40f;
}
.sidebar h2{
  color:#f1c40f;
  margin-bottom:20px;
  text-align:center;
}
.sidebar a{
  display:block;
  width:90%;
  margin:6px auto;
  padding:12px;
  text-align:center;
  background:rgba(255,255,255,.06);
  border-radius:8px;
  color:#fff;
  font-weight:600;
  text-decoration:none;
}
.sidebar a:hover{
  background:#f1c40f;
  color:#1b263b;
}
.main-content{
  flex:1;
  display:flex;
  justify-content:center;
  align-items:center;
}
.btn{
  background:linear-gradient(135deg,#f1c40f,#f39c12);
  border:none;
  padding:15px 25px;
  border-radius:14px;
  font-weight:800;
  cursor:pointer;
  margin:10px;
}
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:none;
  justify-content:center;
  align-items:center;
}
.modal-content{
  background:#fff;
  color:#000;
  width:420px;
  padding:25px;
  border-radius:16px;
}
.form-group{
  margin-bottom:12px;
}
.form-group input{
  width:100%;
  padding:10px;
}
.table-wrap{
  max-height:300px;
  overflow:auto;
}
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  border:1px solid #ccc;
  padding:6px;
  text-align:center;
}
</style>
</head>

<body>

<div class="sidebar">
  <h2>COMERCIAL G.A.</h2>
  <a href="index.html">INICIO</a>
  <a href="ventas.html">VENTAS</a>
</div>

<div class="main-content">
  <button class="btn" onclick="abrirPago()">REGISTRAR PAGO</button>
  <button class="btn" onclick="abrirEstado()">ESTADO DE CUENTA</button>
</div>

<!-- MODAL PAGO -->
<div class="modal" id="modalPago">
  <div class="modal-content">
    <h3>Registrar Pago</h3>
    <div class="form-group">
      <input id="numTarjeta" placeholder="Número de tarjeta">
    </div>
    <div class="form-group">
      <input id="saldoPendiente" readonly placeholder="Saldo pendiente">
    </div>
    <div class="form-group">
      <input id="abono" type="number" placeholder="Abono">
    </div>
    <div class="form-group">
      <input id="saldoRestante" readonly placeholder="Saldo restante">
    </div>
    <button class="btn" onclick="guardarPago()">GUARDAR</button>
    <button class="btn" onclick="cerrarPago()">CERRAR</button>
  </div>
</div>

<!-- MODAL ESTADO -->
<div class="modal" id="modalEstado">
  <div class="modal-content">
    <h3>Estado de Cuenta</h3>
    <div class="form-group">
      <input id="buscarTarjeta" placeholder="Número de tarjeta">
    </div>
    <button class="btn" onclick="buscarEstado()">BUSCAR</button>
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>Fecha</th><th>Detalle</th><th>Abono</th><th>Saldo</th></tr>
        </thead>
        <tbody id="tablaEstado"></tbody>
      </table>
    </div>
    <button class="btn" onclick="cerrarEstado()">CERRAR</button>
  </div>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAfZ0WZVzMxUX2bWmP-iJ0SB-r4q9r026g",
  authDomain: "sucursal-ga.firebaseapp.com",
  databaseURL: "https://sucursal-ga-default-rtdb.firebaseio.com",
  projectId: "sucursal-ga",
  storageBucket: "sucursal-ga.appspot.com",
  messagingSenderId: "692794208494",
  appId: "1:692794208494:web:9ef044edad3263926943ff"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let ventas = [];
let ventaActual = null;

/* CARGA CORRECTA */
db.ref("ventas").on("value", snap => {
  const data = snap.val() || {};
  ventas = Object.keys(data).map(id => ({
    id,
    ...data[id]
  }));
});

/* MODALES */
function abrirPago(){ document.getElementById("modalPago").style.display="flex"; }
function cerrarPago(){ document.getElementById("modalPago").style.display="none"; }
function abrirEstado(){ document.getElementById("modalEstado").style.display="flex"; }
function cerrarEstado(){ document.getElementById("modalEstado").style.display="none"; }

/* BUSCAR TARJETA */
document.getElementById("numTarjeta").addEventListener("change", ()=>{
  const num = numTarjeta.value.trim();
  ventaActual = ventas.find(v => v.numTarjeta === num);
  if(!ventaActual){ alert("No existe"); return; }

  const total = Number(ventaActual.total);
  const abonos = ventaActual.abonos || [];
  const pagado = abonos.reduce((s,a)=>s+Number(a.monto),0);
  const saldo = total - pagado;

  saldoPendiente.value = saldo;
  saldoRestante.value = saldo;
});

/* CALCULO */
abono.addEventListener("input", ()=>{
  saldoRestante.value = saldoPendiente.value - abono.value;
});

/* GUARDAR */
function guardarPago(){
  if(!ventaActual) return alert("Busque tarjeta");

  if(!ventaActual.id){
    ventaActual.id = Date.now().toString();
  }

  if(!ventaActual.abonos) ventaActual.abonos = [];
  ventaActual.abonos.push({
    fecha: new Date().toLocaleDateString(),
    monto: Number(abono.value)
  });

  db.ref("ventas/"+ventaActual.id).set(ventaActual);
  alert("PAGO GUARDADO");
  cerrarPago();
}

/* ESTADO */
function buscarEstado(){
  const num = buscarTarjeta.value.trim();
  const venta = ventas.find(v=>v.numTarjeta===num);
  if(!venta) return alert("No existe");

  const tbody = document.getElementById("tablaEstado");
  tbody.innerHTML="";
  let saldo = venta.total;

  (venta.abonos||[]).forEach(a=>{
    saldo -= a.monto;
    tbody.innerHTML += `<tr>
      <td>${a.fecha}</td>
      <td>Abono</td>
      <td>${a.monto}</td>
      <td>${saldo}</td>
    </tr>`;
  });
}
</script>

</body>
</html>







