<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ventas | Comercial G.A.</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Poppins',Arial,sans-serif;min-height:100vh;display:flex;background:linear-gradient(135deg,#0d1b2a,#1b263b,#415a77);color:#fff}
.sidebar{width:250px;background:#0d1b2a;padding-top:25px;border-right:2px solid #f1c40f;display:flex;flex-direction:column;align-items:center}
.sidebar h2{color:#f1c40f;margin-bottom:25px;font-weight:800}
.sidebar a{width:90%;margin:6px 0;padding:12px;text-align:center;text-decoration:none;color:#fff;background:rgba(255,255,255,.06);border-radius:8px;font-weight:600}
.sidebar a:hover{background:#f1c40f;color:#1b263b}
.main-content{flex:1;padding:40px;overflow-y:auto}
h1{color:#f1c40f;margin-bottom:20px;text-align:center}
.form-container{max-width:900px;margin:auto;background:rgba(255,255,255,.05);padding:30px;border-radius:15px}
.section-title{margin:25px 0 10px;font-weight:600;color:#f1c40f;border-bottom:1px solid rgba(241,196,15,.4)}
.form-row{display:flex;gap:15px;margin-bottom:15px}
.form-group{flex:1;display:flex;flex-direction:column}
label{margin-bottom:5px;font-size:.9em}
input,select,textarea{padding:10px;border-radius:8px;border:none;font-family:'Poppins'}
textarea{resize:none}
.buttons{display:flex;gap:15px;margin-top:25px}
button{flex:1;padding:12px;border:none;border-radius:10px;font-weight:600;cursor:pointer}
.btn-save{background:#27ae60;color:#fff}
.btn-cancel{background:#c0392b;color:#fff}
.info-box{background:rgba(255,255,255,.1);padding:15px;border-radius:10px;margin-bottom:15px}

@media(max-width:768px){
body{flex-direction:column}
.sidebar{width:100%;flex-direction:row;flex-wrap:wrap;justify-content:center;border-right:none;border-bottom:2px solid #f1c40f}
.sidebar a{width:45%}
.main-content{padding:15px}
.form-row{flex-direction:column}
.buttons{flex-direction:column}
}
</style>
</head>

<body>

<div class="sidebar">
  <h2>COMERCIAL G.A.</h2>
  <a href="index.html">Inicio</a>
  <a href="compras.html">Compras</a>
  <a href="inventario.html">Inventario</a>
  <a href="ventas.html">Ventas</a>
</div>

<div class="main-content">
<h1>Registro de Ventas</h1>

<div class="form-container">

<div class="section-title">Buscar Producto por Código</div>
<div class="form-row">
  <div class="form-group">
    <label>Código</label>
    <input type="text" id="codigoBuscar">
  </div>
  <div class="form-group">
    <button class="btn-save" onclick="buscarProducto()">Buscar</button>
  </div>
</div>

<div id="infoProducto" class="info-box" style="display:none">
  <p><strong>Producto:</strong> <span id="infoNombre"></span></p>
  <p><strong>Stock:</strong> <span id="infoStock"></span></p>
  <p><strong>Precio:</strong> $<span id="infoPrecio"></span></p>

  <label>Cantidad</label>
  <input type="number" id="cantidadVenta" min="1" value="1" oninput="calcularTotal()">

  <p><strong>Total:</strong> $<span id="totalVenta">0.00</span></p>
</div>

<div class="section-title">Datos de la Venta</div>

<div class="form-row">
  <div class="form-group">
    <label>Cliente</label>
    <input type="text" id="cliente">
  </div>
  <div class="form-group">
    <label>Vendedor</label>
    <input type="text" id="vendedor">
  </div>
</div>

<div class="form-row">
  <div class="form-group">
    <label>Tipo de Pago</label>
    <select id="tipoPago">
      <option>Contado</option>
      <option>Crédito</option>
    </select>
  </div>
  <div class="form-group">
    <label>Prima</label>
    <input type="number" id="prima" value="0">
  </div>
</div>

<div class="form-row">
  <div class="form-group">
    <label>Fecha</label>
    <input type="date" id="fechaVenta">
  </div>
</div>

<div class="buttons">
  <button class="btn-save" onclick="guardarVenta()">Registrar Venta</button>
  <button class="btn-cancel" onclick="location.reload()">Cancelar</button>
</div>

</div>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAfZ0WZVzMxUX2bWmP-iJ0SB-r4q9r026g",
  authDomain: "sucursal-ga.firebaseapp.com",
  databaseURL: "https://sucursal-ga-default-rtdb.firebaseio.com",
  projectId: "sucursal-ga"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let productoActual = null;

/* ================= BUSCAR PRODUCTO ================= */
function buscarProducto(){
  const codigo = document.getElementById("codigoBuscar").value.trim();

  db.ref("inventario").once("value", snap=>{
    productoActual = null;

    snap.forEach(child=>{
      if(child.val().codigo === codigo){
        productoActual = { id: child.key, ...child.val() };
      }
    });

    if(!productoActual){
      alert("Producto no encontrado");
      return;
    }

    document.getElementById("infoProducto").style.display="block";
    document.getElementById("infoNombre").textContent = productoActual.producto;
    document.getElementById("infoStock").textContent = productoActual.cantidad;
    document.getElementById("infoPrecio").textContent = productoActual.precioVenta;
    calcularTotal();
  });
}

/* ================= CALCULAR TOTAL ================= */
function calcularTotal(){
  const cant = Number(document.getElementById("cantidadVenta").value);
  const total = cant * Number(productoActual.precioVenta);
  document.getElementById("totalVenta").textContent = total.toFixed(2);
}

/* ================= GUARDAR VENTA ================= */
function guardarVenta(){
  if(!productoActual) return alert("Busque un producto");
  const cantidad = Number(cantidadVenta.value);
  if(cantidad > productoActual.cantidad) return alert("Stock insuficiente");

  const total = Number(document.getElementById("totalVenta").textContent);
  const tipoPago = tipoPagoSelect.value;
  const prima = tipoPago === "Contado" ? total : Number(primaInput.value);
  const saldo = total - prima;

  const venta = {
    codigo: productoActual.codigo,
    producto: productoActual.producto,
    cantidad,
    total,
    tipoPago,
    prima,
    saldo,
    cliente: cliente.value,
    vendedor: vendedor.value,
    fecha: fechaVenta.value,
    fechaRegistro: new Date().toISOString()
  };

  db.ref("ventas").push(venta);
  db.ref("inventario/"+productoActual.id).update({
    cantidad: productoActual.cantidad - cantidad
  });

  alert("✅ Venta registrada correctamente");
  location.reload();
}
</script>

</body>
</html>
